{% extends 'base.html' %}
{% load static %}
{% block title %}AllSpeseGestione{% endblock title %}
{% block name %}<i>SPESE DI GESTIONE</i>{% endblock %}
{% block scripts %}
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script type="text/javascript">
        	function selectAll(){
                var items = document.getElementsByName('b1');
                for(var i=0; i<items.length; i++){
                    if(items[i].type === 'checkbox') {
                        items[i].checked = true;
                        items[i].closest('tr').classList.add('selected-row');
                    }
                }
            }
			function unSelectAll(){
                var items = document.getElementsByName('b1');
                for(var i=0; i<items.length; i++){
                    if(items[i].type === 'checkbox') {
                        items[i].checked = false;
                        items[i].closest('tr').classList.remove('selected-row');
                    }
                }
            }
			function getSelected(){
				var checks=document.getElementsByName('b1');
				var list = new Array();
				for(var i=0; i<checks.length; i++){
					if(checks[i].checked== true){
						list.push(checks[i].value);
					}
				}
				return list;
			}
            function deleteGroup() {
                var list = getSelected();
                if (list.length > 0) {
                    Swal.fire({
                        title: 'Sei sicuro di voler eliminare le Spese di Gestione selezionate?',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Sì, elimina!',
                        cancelButtonText: 'Annulla'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            $.ajax({
                                type: "POST",
                                url: "/DeleteSpeseGestioneGroup/",
                                data: {
                                    'list': list,
                                    csrfmiddlewaretoken: '{{ csrf_token }}'
                                },
                                success: function(response) {
                                    location.reload(true);
                                },
                                error: function(response) {
                                    Swal.fire('Errore', 'Si è verificato un errore durante l\'eliminazione.', 'error');
                                }
                            });
                        }
                    });
                }
            }
            $(document).ready(function() {
                $('input[type="checkbox"][name="b1"]').on('change', function() {
                    const row = $(this).closest('tr');
                    if ($(this).is(':checked')) {
                        row.addClass('selected-row');
                    } else {
                        row.removeClass('selected-row');
                    }
                });
            });
            document.addEventListener("DOMContentLoaded", function () {
                const form = document.getElementById("filter-form");
                if (!form) return;

                // Submit automatico per select, checkbox, radio, date
                form.querySelectorAll("select, input[type='checkbox'], input[type='radio'], input[type='date']").forEach(function(field) {
                    field.addEventListener("change", function() {
                        form.submit();
                    });
                });
                // Per input testo nessun submit automatico (usa solo bottone)
            });
    </script>
{% endblock %}

{% block content %}
    <form id="filter-form" method="get">
        <div class="filter-form">
            {% for field in filter.form %}
                <div class="filter-item">
                    <label class="filter-label" for="{{ field.id_for_label }}">
                        {{ field.label }}
                    </label>
                    {{ field }}
                </div>
            {% endfor %}
        </div>
        <div class="filter-actions">
            <button type="submit" class="btn btn-light">
                <i class="fa fa-filter" aria-hidden="true"></i> Filtra
            </button>
        </div>
    </form>
    </br></br>
    <style>
        tr.selected-row {
            background-color: #fffaaf !important;
            color: #333 !important;
        }
    </style>
    <table align="left" style="width:100%">
        <tr>
            <td align="left" class="d-flex gap-2 flex-wrap">
                <button onclick="selectAll()" class="btn-custom btn-select">
                    <i class="fas fa-check-square"></i> Seleziona Tutti
                </button>
                <button onclick="unSelectAll()" class="btn-custom btn-unselect">
                    <i class="fas fa-square"></i> Deseleziona Tutti
                </button>
                <button onclick="deleteGroup()" class="btn-custom btn-delete">
                    <i class="fas fa-trash-alt"></i> Elimina Selezionati
                </button>
                <a href="{% url 'CreateSpesaGestione' %}" class="btn-custom btn-add">
                    <i class="fas fa-plus"></i> Aggiungi
                </a>
            </td>
            <td >
                <div align="right">
                <form method="post" action="{% url 'export_input_table_xls' list=filter_queryset model='spesagestione' %}">
                    {% csrf_token %}
                    <div class="input-group">
                        <input class="form-control form-control" type="text" name="fname" placeholder="NomeDelFile" required>
                        <button type="submit" class="btn btn-primary"><i class="fa fa-download"></i> Scarica Excel</button>
                    </div>
                </form>
                </div>
            </td>
        </tr>
    </table>
    <div style="max-height:500px; overflow-x:auto; overflow-y:auto; border:1px solid black;">
        <table class="tabella-con-bordi" width="100%" border="1" cellpadding="5" cellspacing="0">
            <thead bgcolor="#383838" style="color:white; position: sticky; top: 0; z-index: 100;">
                <tr>
                    <th></th>
                    <th>MODIFICA</th>
                    <th>Registrazione</th>
                    <th>Importo</th>
                    <th>Causale</th>
                    <th>Fattura</th>
                    <th>Note</th>
                    <th>Provenienza</th>
                </tr>
            </thead>
            <tbody bgcolor="#585858" style="color:white;">
                {% for b in filter_queryset %}
                <tr>
                    <td style='width: 10px;'>
                        <input type="checkbox" class="checks" name="b1" value={{b.id}}>
                    </td>
                    <td style='width: 15px;' align="center"><a href="/UpdateSpesaGestione/{{ b.id }}" class="btn btn-success btn-sm" role="button" aria-pressed="true"><span style='font-size:15px;'>&#x21F2;</span></a></td>
                    <td style='width: 90px;'>{{ b.data_registrazione }}</td>
                    <td style='width: 80px; text-align: right;'>{{ b.importo }} €</td>
                    <td style='width: 100px; overflow: auto;'>
                        {% if b.f24 %}
                            <a href="/F24Detail/{{ b.f24.id }}">
                                {{ b.f24|default_if_none:'' }}
                            </a>
                        {% elif b.causale %}
                            {{ b.causale }}
                        {% else %}
                            &nbsp;
                        {% endif %}
                    </td>
                    <td style='width: 110px;'>{{ b.fattura|default_if_none:'' }}</td>
                    <td style='width: 300px; text-align: left;'>{{ b.note|default_if_none:'' }}</td>
                    <td style='width: 110px;'>{{ b.provenienza|default_if_none:'' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="alert alert-primary" role="alert">
        Totale degli importi: <a href="#" class="alert-link">{{sum_s}} €</a>
    </div>
{% endblock %}