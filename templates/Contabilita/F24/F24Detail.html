{% extends 'base.html' %}
{% load static %}
{% block title %}F24Detail{% endblock title %}
{% block name %}<i>DETTAGLIO F24 - {{ codice_f24 }}</i>{% endblock %}
{% block scripts %}
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script type="text/javascript">
            function selectAll(){
                var items = document.getElementsByName('b1');
                for(var i=0; i<items.length; i++){
                    if(items[i].type === 'checkbox') {
                        items[i].checked = true;
                        items[i].closest('tr').classList.add('selected-row');
                    }
                }
            }
			function unSelectAll(){
                var items = document.getElementsByName('b1');
                for(var i=0; i<items.length; i++){
                    if(items[i].type === 'checkbox') {
                        items[i].checked = false;
                        items[i].closest('tr').classList.remove('selected-row');
                    }
                }
            }
			function getSelected(){
				var checks=document.getElementsByName('b1');
				var list = new Array();
				for(var i=0; i<checks.length; i++){
					if(checks[i].checked== true){
						list.push(checks[i].value);
					}
				}
				return list;
			}
            function deleteGroup() {
                var list = getSelected();
                if (list.length > 0) {
                    Swal.fire({
                        title: 'Sei sicuro di voler eliminare i Codici Tributo selezionati?',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Sì, elimina!',
                        cancelButtonText: 'Annulla'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            $.ajax({
                                type: "POST",
                                url: "{% url 'DeleteCodiciTributoGroup' f24_id=f24_id %}",
                                data: {
                                    'list': list,
                                    csrfmiddlewaretoken: '{{ csrf_token }}'
                                },
                                success: function(response) {
                                    location.reload(true);
                                },
                                error: function(response) {
                                    Swal.fire('Errore', 'Si è verificato un errore durante l\'eliminazione.', 'error');
                                }
                            });
                        }
                    });
                }
            }
            $(document).ready(function() {
                $('input[type="checkbox"][name="b1"]').on('change', function() {
                    const row = $(this).closest('tr');
                    if ($(this).is(':checked')) {
                        row.addClass('selected-row');
                    } else {
                        row.removeClass('selected-row');
                    }
                });
            });
            document.addEventListener("DOMContentLoaded", function () {
                const form = document.getElementById("filter-form");
                if (!form) return;

                // Submit automatico per select, checkbox, radio, date
                form.querySelectorAll("select, input[type='checkbox'], input[type='radio'], input[type='date']").forEach(function(field) {
                    field.addEventListener("change", function() {
                        form.submit();
                    });
                });
                // Per input testo nessun submit automatico (usa solo bottone)
            });
    </script>
{% endblock %}

{% block content %}
    <style>
        tr.selected-row {
            background-color: #fffaaf !important;
            color: #333 !important;
        }
        table a {
            color: #87ceeb;
            text-decoration: none;
        }
        table a:hover {
            color: #87ceeb;
            text-decoration: underline;
        }
    </style>

    <div class="row mb-3">
        <div class="col-md-4">
            <table class="table table-borderless">
                <tr>
                    <td><strong>Identificativo F24</strong></td>
                    <td align="left">{{ codice_f24 }}</td>
                </tr>
                <tr>
                    <td><strong>Data Scadenza F24</strong></td>
                    <td align="left">{{ data_scadenza_f24 }}</td>
                </tr>
                <tr>
                    <td><strong>Ente</strong></td>
                    <td align="left">{{ ente }}</td>
                </tr>
            </table>
        </div>
    </div>

    <table align="left" style="width:100%">
        <tr>
            <td align="left" class="d-flex gap-2 flex-wrap">
                <button onclick="selectAll()" class="btn-custom btn-select">
                    <i class="fas fa-check-square"></i> Seleziona Tutti
                </button>
                <button onclick="unSelectAll()" class="btn-custom btn-unselect">
                    <i class="fas fa-square"></i> Deseleziona Tutti
                </button>
                <button onclick="deleteGroup()" class="btn-custom btn-delete">
                    <i class="fas fa-trash-alt"></i> Elimina Selezionati
                </button>
                <a href="{% url 'CreateCodiceTributo' f24_id=f24_id %}" class="btn-custom btn-add">
                    <i class="fas fa-plus"></i> Aggiungi Codice Tributo
                </a>
            </td>
        </tr>
    </table>

    <div style="max-height:500px; overflow-x:auto; overflow-y:auto; border:1px solid black;">
        <table class="tabella-con-bordi" width="100%" border="1" cellpadding="5" cellspacing="0">
            <thead bgcolor="#383838" style="color:white; position: sticky; top: 0; z-index: 100;">
                <tr>
                    <th></th>
                    <th>Modifica</th>
                    <th>Identificativo Codice Tributo</th>
                    <th>Anno</th>
                    <th>Mese</th>
                    <th>Debito</th>
                    <th>Credito</th>
                </tr>
            </thead>
            {% for b in filter_queryset %}
                <tr style="background-color:#585858; color:white;">
                    <td style='width: 5px;'>
                        <input type="checkbox" class="checks" name="b1" value={{b.id}}>
                    </td>
                    <td style='width: 10px;' align="center"><a href="{% url 'UpdateCodiceTributo' id=b.id f24_id=b.f24.id %}" class="btn btn-success btn-sm" role="button" aria-pressed="true"><span style='font-size:15px;'>&#x21F2;</span></a></td>
                    <td style='width: 20px;'>{{ b.identificativo }}</td>
                    <td style='width: 50px;'>{{ b.anno }}</td>
                    <td style='width: 50px;'>{{ b.mese|default_if_none:'' }}</td>
                    <td style='width: 50px;'>
                        {% if b.debito %}
                            {{ b.debito }} €
                        {% else %}
                            &nbsp;
                        {% endif %}
                    </td>
                    <td style='width: 70px;'>
                        {% if b.credito %}
                            {{ b.credito }} €
                        {% else %}
                            &nbsp;
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
        </table>
    </div>
    <div class="alert alert-primary" role="alert">
        Importo Totale: <a href="#" class="alert-link">{{importo}} €</a>
    </div>
{% endblock %}