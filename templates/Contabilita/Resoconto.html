{% extends 'base.html' %}
{% load static %}
{% block title %}Resoconto{% endblock title %}
{% block name %}<i>RESOCONTO CONTABILE</i>{% endblock %}
{% block content %}

    <script>
      setTimeout(function () {
        const alert = document.getElementById('alert-error');
        if (alert) {
          alert.classList.remove('show');
          alert.classList.add('fade');  // assicura l'effetto fade-out
          // Rimuove l'elemento dopo la transizione
          setTimeout(() => alert.remove(), 500); // tempo per la transizione fade
        }
      }, 5000);
    </script>

    {% if form.non_field_errors %}
        <div class="alert alert-danger fade show" role="alert" id="alert-error">
            <ul>
                {% for error in form.non_field_errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}

    <form method="post">
      {% csrf_token %}
      <table style="width: 25%;" align="left">
        <tr>
          <td style="width: 50%; vertical-align: top;">
            <label for="{{ form.anno_inizio.id_for_label }}" style="text-align: left; display: block;"><strong>{{ form.anno_inizio.label }}</strong></label>
            {{ form.anno_inizio }}<br>
            <label for="{{ form.anno_fine.id_for_label }}" style="text-align: left; display: block;"><strong>{{ form.anno_fine.label }}</strong></label>
            {{ form.anno_fine }}
          </td>
          <td style="width: 50%; vertical-align: top;">
            <label for="{{ form.mese_inizio.id_for_label }}" style="text-align: left; display: block;"><strong>{{ form.mese_inizio.label }}</strong></label>
            {{ form.mese_inizio }}<br>
            <label for="{{ form.mese_fine.id_for_label }}" style="text-align: left; display: block;"><strong>{{ form.mese_fine.label }}</strong></label>
            {{ form.mese_fine }}
          </td>
        </tr>
        <tr>
          <td style="padding-top: 20px;" align="left">
            <!-- Bottone Crea a sinistra -->
            <input type="submit" class="btn btn-primary" value="&#8595; Crea">
          </td>
        </tr>
      </table>
    </form>

    <table align="right">
        <tr>
          <td>
              <form method="post" action="{% url 'export_output_table_xls' numquery=1 data_inizio=data_inizio data_fine=data_fine %}">
                {% csrf_token %}
                <input type="text" name="fname" placeholder="NomeDelFile" required>
                <button type="submit" class="btn btn-primary">
                    <i class="fa fa-download"></i> Scarica Excel
                </button>
              </form>
          </td>
        </tr>
    </table>

    {% if labels %}
        <div style="margin-top: 50px;">
          <canvas id="myChart" width="100%" height="40"></canvas>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
              const labels = {{ labels|safe }};
              const data = {
                labels: labels,
                datasets: [
                  {
                    label: 'Spese di gestione (€)',
                    data: {{ serie2|safe }},
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    pointBackgroundColor: 'rgba(255, 99, 132, 1)',
                    pointRadius: 5,
                    fill: true,
                    tension: 0.3
                  },
                  {
                    label: 'Ricavi (€)',
                    data: {{ serie1|safe }},
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                    pointRadius: 5,
                    fill: true,
                    tension: 0.3
                  },
                  {
                    label: 'Utile (€)',
                    data: {{ serie3|safe }},
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    pointBackgroundColor: 'rgba(75, 192, 192, 1)',
                    pointRadius: 5,
                    fill: true,
                    tension: 0.3
                  }
                ]
              };

              const config = {
                type: 'line',
                data: data,
                options: {
                  responsive: true,
                  plugins: {
                    title: {
                      display: true,
                      text: 'Andamento mensile Spese, Ricavi e Utile'
                    },
                    legend: {
                      position: 'top'
                    }
                  },
                  scales: {
                    y: {
                      beginAtZero: true,
                      grace: '10%',  // ⬅️ Spazio sopra le linee per evitare effetto “schiacciato”
                      ticks: {
                        stepSize: 10   // ⬅️ Più leggibile se i valori variano poco
                      }
                    }
                  },
                  elements: {
                    point: {
                      radius: 5,
                      borderWidth: 2,
                      hoverRadius: 7
                    },
                    line: {
                      borderWidth: 2
                    }
                  }
                }
              };

              new Chart(document.getElementById('myChart'), config);
        </script>
    {% endif %}
    <br>
    <table class="tabella-con-bordi" width="100%" border="1" cellpadding="5" cellspacing="0">
        <thead bgcolor="#383838" style="color:white;">
            <tr>
                <th>Anno-Mese</th>
                <th>Ricavi</th>
                <th>Spese di gestione</th>
                <th>Utile</th>
            </tr>
        </thead>
        <tbody bgcolor="#585858" style="color:white;">
            {% for item in tabella_output1 %}
                {% if forloop.last %}
                    <tr>
                        <td>{{ item.0 }}</td>
                        <td style='text-align: right;'>{{ item.1|floatformat:2 }} €</td>
                        <td style='text-align: right;'>{{ item.2|floatformat:2 }} €</td>
                        <td style='text-align: right;'>{{ item.3|floatformat:2 }} €</td>
                    </tr>
                {% else %}
                    <tr>
                        <td>{{ item.0 }}</td>
                        <td style='text-align: right;'>{{ item.1|floatformat:2 }} €</td>
                        <td style='text-align: right;'>{{ item.2|floatformat:2 }} €</td>
                        <td style='text-align: right;'>{{ item.3|floatformat:2 }} €</td>
                    </tr>
                {% endif %}
            {% endfor %}
        </tbody>
    </table>

{% endblock %}